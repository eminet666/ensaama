<!-- https://www.w3docs.com/snippets/javascript/how-to-create-and-trigger-event-in-javascript.html -->
<html>

<head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.0.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    </script>

    <script>
        let player = {
            pos: {
                x: 0,
                y: 0,
                z: 0
            }
        }

        AFRAME.registerComponent('currentposition', {
            tick: function () {
                var pos = this.el.object3D.position;
                var wposition = new THREE.Vector3();
                var wpos = this.el.object3D.getWorldPosition(wposition);

                player.pos.x = pos.x + wpos.x;
                player.pos.y = pos.y + wpos.y;
                player.pos.z = pos.z + wpos.z;
                //console.log(player.pos);
            }
        });
        AFRAME.registerComponent('myproximity', {
            schema: {
                trace: {
                    type: 'boolean',
                    default: false
                },
                seuil: {
                    type: 'number',
                    default: 0.5
                },
                action: {
                    type: 'string',
                    default: 'color'
                },
                enter: {
                    type: 'string',
                    default: 'white'
                },
                exit: {
                    type: 'string',
                    default: 'black'
                },
                flagin: {
                    type: 'string',
                    default: 'exit'
                }
            },
            init: function () {
                var el = this.el;
                var action = this.data.action;
                var enter = this.data.enter.split('-');
                var exit = this.data.exit.split('-');
                var flagin = this.data.flagin;

                // Ecouter l'événement.
                el.addEventListener('enter', function (e) {
                    console.log("enter_" + flagin);
                    if (flagin == 'exit') {
                        switch (action) {
                            case 'color':
                                el.setAttribute('material', 'color', 'red');
                                break;
                            case 'anim':
                                el.setAttribute("look-at", '#'+ enter[1]);
                                el.setAttribute("animation-mixer", 'clip: ' + enter[0]);
                                var parameters="property: position; dur: 2000; easing: linear; to: 1 0 -2; loop: false";
                                el.setAttribute('animation', parameters);
                                setTimeout(function(){
                                    el.setAttribute('animation-mixer', 'clip: Survey');
                                    el.setAttribute('look-at', '[camera]');
                                }, 2000);    
                                break;
                        }
                        //flagin = 'enter';
                    }
                }, false);
                // el.addEventListener('exit', function (e) {
                //     console.log("exit_" + flagin);
                //     if (flagin == 'enter') {
                //         switch (action) {
                //             case 'color':
                //                 el.setAttribute('material', 'color', 'blue');
                //                 break;
                //             case 'anim':
                //                 el.setAttribute('animation-mixer', 'clip: ' + exit[0]);

                //                 const repos = setTimeout(function () {
                //                     el.setAttribute('animation-mixer', 'clip: Survey');
                //                     el.setAttribute('look-at', '[camera]');
                //                 }, 5000);
                //         }
                //         flagin = 'exit'
                //     }
                // }, false);

            },
            tick: function () {
                var seuil = this.data.seuil;
                var pos = this.el.object3D.position;
                var distance = dist(pos);

                if (distance < seuil) {
                    if (!this.data.flagin) {
                        this.el.emit('enter'); 
                        this.data.flagin = true;
                        console.log("in");
                    }
                } else {
                    if (this.data.flagin) {
                        this.el.emit('exit'); 
                        this.data.flagin = false;
                        console.log("out");
                    }
                } if (this.data.trace) {
                    var log = document.querySelector('#txtlog');
                    log.setAttribute('value', 'distance : ' + distance.toFixed(2));
                }
            }
        });

        function dist(mypos) {
            return Math.sqrt((player.pos.x - mypos.x) ** 2 + (player.pos.z - mypos.z) ** 2)
        }
    </script>

</head>

<body>

    <a-scene background="color: skyblue">

        <a-assets>
            <a-asset-item id="fox" src="./fox.glb"></a-asset-item>
        </a-assets>

        <a-box id="cible0" visible="false" width="0.25" height="0.25" depth="0.25" position="-1 0 -2" rotation="0 45 0"
            color="silver">
        </a-box>
        <a-box id="cible1" visible="false" width="0.25" height="0.25" depth="0.25" position="1 0 -2" rotation="0 45 0"
            color="silver">
        </a-box>

        <a-entity id="renard" position="-1 0 -2" scale="0.005 0.005 0.005" gltf-model="#fox"
            animation-mixer="clip: Survey" look-at="[camera]"
            myproximity='trace: true; seuil: 1; action: anim; enter: Run-cible1; exit: Walk-cible0'>
        </a-entity>

        <a-plane position="0 0 -2" rotation="-90 0 0" width="4" height="4" color="gray">
        </a-plane>

        <a-entity camera position="0 0.5 0" look-controls wasd-controls="acceleration:10" currentposition>
            <a-text id="txtlog" value="position" position="0 0 -1" rotation="0 0 0" scale="0.5 0.5 0.5" align="center"
                color="#FF0000">
            </a-text>
        </a-entity>

    </a-scene>

</body>

</html>